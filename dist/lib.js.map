{"version":3,"file":"lib.js","sources":["../src/isPrettyMuchAnInteger.ts","../src/fpr.ts","../vendor/BrowserZoomListener.ts","../vendor/SimpleResizeObserver.ts","../src/BasedCanvas.ts"],"sourcesContent":["const TOLERANCE = 0.001;\nexport default function isPrettyMuchAnInteger(n: number): boolean {\n   return Math.abs(n - (n|0)) < TOLERANCE;\n}\n","import { CSSPixels, DisplayPixels } from \"./pixels\";\nimport isPrettyMuchAnInteger from \"./isPrettyMuchAnInteger\";\n\nconst CSS_PIXELS_LIMIT = 100;\n\nexport type FractionalPixelRatio = {\n   readonly dpx: DisplayPixels,\n   readonly cpx: CSSPixels,\n}; // would be nice to have a tuple type\n\n/**\n * If you really want you can use this export in a pointer-like way to check\n * if getFPR returned the default.\n */\nexport const defaultFPR = {\n   dpx: 1 as DisplayPixels,\n   cpx: 1 as CSSPixels\n};\n\nexport function getFPR(): FractionalPixelRatio {\n   const dpr = window.devicePixelRatio;\n   for (let co = 1; co < CSS_PIXELS_LIMIT; co++) {\n      if (isPrettyMuchAnInteger(dpr * co)) {\n         return {\n            dpx: Math.round(dpr * co) as DisplayPixels,\n            cpx: co as CSSPixels,\n         };\n      }\n   }\n   return defaultFPR;\n}\n","type NumberConsumer = (dpr: number) => void;\nlet lastdpr = window.devicePixelRatio;\nconst fns: NumberConsumer[] = [];\n\nfunction dispatch() {\n   const dpr = window.devicePixelRatio;\n   if (dpr !== lastdpr) {\n      for (var i = 0; i < fns.length; i++) {\n         fns[i](dpr);\n      }\n      lastdpr = dpr;\n   }\n}\n\nwindow.addEventListener(\"resize\", dispatch);\n\nexport default function browserZoomListener(fn: NumberConsumer): void {\n   fns.push(fn);\n}\n","/// <reference types=\"./ResizeObserver\"/>\n\ntype SimpleResizeObserverFn = (entry: ResizeObserverEntry) => void;\ntype BoxOptions = ResizeObserverObserveOptions[\"box\"];\n\nexport default class SimpleResizeObserver {\n   #observer: ResizeObserver;\n   #fn: SimpleResizeObserverFn;\n   constructor(el: Element, fn: SimpleResizeObserverFn, box: BoxOptions = \"content-box\") {\n      this.#fn = fn;\n      this.#observer = new ResizeObserver(this.dispatch.bind(this));\n      this.#observer.observe(el, { box });\n   }\n\n   dispatch(entries: ResizeObserverEntry[]) {\n      this.#fn(entries[0]);\n   }\n\n   disconnect() {\n      this.#observer.disconnect();\n   }\n}\n","/// <reference types=\"../vendor/ResizeObserver\"/>\nimport { CSSPixels, RasterUnits } from \"./pixels\";\nimport { getFPR } from \"./fpr\";\n\nimport browserZoomListener from \"../vendor/BrowserZoomListener\";\nimport SimpleResizeObserver from \"../vendor/SimpleResizeObserver\";\n\nfunction noop() {}\n\ntype FPRCount = { x: number, y: number };\n\nexport default class BasedCanvas {\n   /**\n    * This object is not mutated.\n    * Copying it into another variable will leave you with old data\n    */\n   static fpr = getFPR();\n   private static fprListeners: (() => void)[] = [];\n   static updateFPR() {\n      console.log(\"updateFPR\");\n      BasedCanvas.fpr = getFPR();\n      BasedCanvas.fprListeners.forEach(listener => listener());\n   }\n\n   private setCanvasSize(width: CSSPixels, height: CSSPixels) {\n      console.group(`setCanvasSize(${width}, ${height})`);\n      this.#canvas.style.width = `${width}px`;\n      this.#canvas.style.height = `${height}px`;\n      console.groupEnd();\n   }\n\n   private setContextSize(width: RasterUnits, height: RasterUnits) {\n      console.group(`setContextSize(${width}, ${height})`);\n      // annoyingly, these get cleared when the HTMLCanvasElement is resized\n      // so we can't ctx.save\n      // this.#ctx.save();\n      this.#canvas.width = width;\n      this.#canvas.height = height;\n      // this.#ctx.restore();\n      console.groupEnd();\n   }\n\n   private getFPRCount(): FPRCount {\n      const { cpx } = BasedCanvas.fpr;\n      return {\n         x: this.#containerWidth / cpx | 0,\n         y: this.#containerHeight / cpx | 0,\n      };\n   }\n\n   private browserZoomed(): void {\n      console.group(\"browserZoomed\");\n      const { x: fprCountX, y: fprCountY } = this.getFPRCount();\n      const { cpx } = BasedCanvas.fpr;\n\n      const cpxx = (fprCountX * cpx) as CSSPixels;\n      const cpxy = (fprCountY * cpx) as CSSPixels;\n      this.setCanvasSize(\n         cpxx,\n         cpxy,\n      );\n      console.info(`calling this.canvasZoomed(${cpxx}, ${cpxy})`);\n      this.canvasZoomed(cpxx, cpxy);\n      console.groupEnd();\n   }\n\n   #containerWidth!: CSSPixels;\n   #containerHeight!: CSSPixels;\n   private containerResized(entry: ResizeObserverEntry) {\n      console.group(\"containerResized\");\n      // save the state\n      const containerSize = entry.contentRect;\n      console.log(`${containerSize.width}, ${containerSize.height}`);\n      this.#containerWidth = containerSize.width as CSSPixels;\n      this.#containerHeight = containerSize.height as CSSPixels;\n\n      // do the resize\n      const { x: fprCountX, y: fprCountY } = this.getFPRCount();\n      const { cpx, dpx } = BasedCanvas.fpr;\n\n      this.setCanvasSize(\n         (fprCountX * cpx) as CSSPixels,\n         (fprCountY * cpx) as CSSPixels,\n         );\n         \n      const rpxx = (fprCountX * dpx) as RasterUnits;\n      const rpxy = (fprCountY * dpx) as RasterUnits;\n      this.setContextSize(\n         rpxx,\n         rpxy,\n      );\n\n      console.info(`calling this.canvasResized(${rpxx}, ${rpxy})`);\n      this.canvasResized(rpxx, rpxy);\n      console.groupEnd();\n   }\n\n   #containerResizeObserver!: SimpleResizeObserver;\n   private registerListeners() {\n      BasedCanvas.fprListeners.push(this.browserZoomed.bind(this));\n      this.#containerResizeObserver = (\n         new SimpleResizeObserver(this.#container, this.containerResized.bind(this))\n      );\n   }\n\n   public canvasZoomed: (width: CSSPixels, height: CSSPixels) => void = noop;\n   /** You should probably write your own paint function */\n   public canvasResized: (width: RasterUnits, height: RasterUnits) => void = noop;\n\n   readonly #container: HTMLElement;\n   readonly #canvas: HTMLCanvasElement;\n   readonly #ctx: CanvasRenderingContext2D;\n\n   constructor (container: HTMLElement, alpha = false) {\n      this.#container = container;\n      this.#canvas = document.createElement(\"canvas\");\n      const ctx = this.#canvas.getContext(\"2d\", { alpha });\n      if (ctx == null) {\n         throw new Error('HTMLElement.getContext(\"2d\") returned null!');\n      }\n      this.#ctx = ctx; // I love flow analysis\n      this.registerListeners();\n      this.\n      container.appendChild(this.#canvas);\n      container.style.overflow = \"hidden\";\n   }\n\n   get container() { return this.#container }\n   get canvas() { return this.#canvas }\n   get ctx() { return this.#ctx }\n   get width(): RasterUnits {\n      return this.#canvas.width as RasterUnits;\n   }\n   get height(): RasterUnits {\n      return this.#canvas.height as RasterUnits;\n   }\n}\n\nbrowserZoomListener(BasedCanvas.updateFPR);\n"],"names":["__classPrivateFieldSet","__classPrivateFieldGet"],"mappings":";;AAAA,MAAM,SAAS,GAAG,KAAK,CAAC;SACA,qBAAqB,CAAC,CAAS;IACpD,OAAO,IAAI,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,GAAC,CAAC,CAAC,CAAC,GAAG,SAAS,CAAC;AAC1C;;ACAA,MAAM,gBAAgB,GAAG,GAAG,CAAC;AAO7B;;;;AAIO,MAAM,UAAU,GAAG;IACvB,GAAG,EAAE,CAAkB;IACvB,GAAG,EAAE,CAAc;CACrB,CAAC;SAEc,MAAM;IACnB,MAAM,GAAG,GAAG,MAAM,CAAC,gBAAgB,CAAC;IACpC,KAAK,IAAI,EAAE,GAAG,CAAC,EAAE,EAAE,GAAG,gBAAgB,EAAE,EAAE,EAAE,EAAE;QAC3C,IAAI,qBAAqB,CAAC,GAAG,GAAG,EAAE,CAAC,EAAE;YAClC,OAAO;gBACJ,GAAG,EAAE,IAAI,CAAC,KAAK,CAAC,GAAG,GAAG,EAAE,CAAkB;gBAC1C,GAAG,EAAE,EAAe;aACtB,CAAC;SACJ;KACH;IACD,OAAO,UAAU,CAAC;AACrB;;AC7BA,IAAI,OAAO,GAAG,MAAM,CAAC,gBAAgB,CAAC;AACtC,MAAM,GAAG,GAAqB,EAAE,CAAC;AAEjC,SAAS,QAAQ;IACd,MAAM,GAAG,GAAG,MAAM,CAAC,gBAAgB,CAAC;IACpC,IAAI,GAAG,KAAK,OAAO,EAAE;QAClB,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,GAAG,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE;YAClC,GAAG,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,CAAC;SACd;QACD,OAAO,GAAG,GAAG,CAAC;KAChB;AACJ,CAAC;AAED,MAAM,CAAC,gBAAgB,CAAC,QAAQ,EAAE,QAAQ,CAAC,CAAC;SAEpB,mBAAmB,CAAC,EAAkB;IAC3D,GAAG,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;AAChB;;AClBA;;;;;;;;;;;;;;;MAKqB,oBAAoB;IAGtC,YAAY,EAAW,EAAE,EAA0B,EAAE,MAAkB,aAAa;QAFpF,4BAA0B;QAC1B,sBAA4B;QAEzB,uBAAA,IAAI,OAAO,EAAE,EAAC;QACd,uBAAA,IAAI,aAAa,IAAI,cAAc,CAAC,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,EAAC;QAC9D,wCAAe,OAAO,CAAC,EAAE,EAAE,EAAE,GAAG,EAAE,CAAC,CAAC;KACtC;IAED,QAAQ,CAAC,OAA8B;QACpC,uCAAA,IAAI,EAAK,OAAO,CAAC,CAAC,CAAC,CAAC,CAAC;KACvB;IAED,UAAU;QACP,wCAAe,UAAU,EAAE,CAAC;KAC9B;CACH;;;;;;;;;;;;;;;;;ACdD,SAAS,IAAI,MAAK;MAIG,WAAW;IAsG7B,YAAa,SAAsB,EAAE,KAAK,GAAG,KAAK;QA/ClD,kCAA4B;QAC5B,mCAA6B;QA8B7B,2CAAgD;QAQzC,iBAAY,GAAkD,IAAI,CAAC;;QAEnE,kBAAa,GAAsD,IAAI,CAAC;QAE/E,6BAAiC;QACjC,0BAAoC;QACpC,uBAAwC;QAGrCA,yBAAA,IAAI,cAAc,SAAS,EAAC;QAC5BA,yBAAA,IAAI,WAAW,QAAQ,CAAC,aAAa,CAAC,QAAQ,CAAC,EAAC;QAChD,MAAM,GAAG,GAAGC,wCAAa,UAAU,CAAC,IAAI,EAAE,EAAE,KAAK,EAAE,CAAC,CAAC;QACrD,IAAI,GAAG,IAAI,IAAI,EAAE;YACd,MAAM,IAAI,KAAK,CAAC,6CAA6C,CAAC,CAAC;SACjE;QACDD,yBAAA,IAAI,QAAQ,GAAG,EAAC;QAChB,IAAI,CAAC,iBAAiB,EAAE,CAAC;QACzB,IAAI;YACJ,SAAS,CAAC,WAAW,yCAAc,CAAC;QACpC,SAAS,CAAC,KAAK,CAAC,QAAQ,GAAG,QAAQ,CAAC;KACtC;IA3GD,OAAO,SAAS;QACb,OAAO,CAAC,GAAG,CAAC,WAAW,CAAC,CAAC;QACzB,WAAW,CAAC,GAAG,GAAG,MAAM,EAAE,CAAC;QAC3B,WAAW,CAAC,YAAY,CAAC,OAAO,CAAC,QAAQ,IAAI,QAAQ,EAAE,CAAC,CAAC;KAC3D;IAEO,aAAa,CAAC,KAAgB,EAAE,MAAiB;QACtD,OAAO,CAAC,KAAK,CAAC,iBAAiB,KAAK,KAAK,MAAM,GAAG,CAAC,CAAC;QACpDC,wCAAa,KAAK,CAAC,KAAK,GAAG,GAAG,KAAK,IAAI,CAAC;QACxCA,wCAAa,KAAK,CAAC,MAAM,GAAG,GAAG,MAAM,IAAI,CAAC;QAC1C,OAAO,CAAC,QAAQ,EAAE,CAAC;KACrB;IAEO,cAAc,CAAC,KAAkB,EAAE,MAAmB;QAC3D,OAAO,CAAC,KAAK,CAAC,kBAAkB,KAAK,KAAK,MAAM,GAAG,CAAC,CAAC;;;;QAIrDA,wCAAa,KAAK,GAAG,KAAK,CAAC;QAC3BA,wCAAa,MAAM,GAAG,MAAM,CAAC;;QAE7B,OAAO,CAAC,QAAQ,EAAE,CAAC;KACrB;IAEO,WAAW;QAChB,MAAM,EAAE,GAAG,EAAE,GAAG,WAAW,CAAC,GAAG,CAAC;QAChC,OAAO;YACJ,CAAC,EAAEA,kDAAuB,GAAG,GAAG,CAAC;YACjC,CAAC,EAAEA,mDAAwB,GAAG,GAAG,CAAC;SACpC,CAAC;KACJ;IAEO,aAAa;QAClB,OAAO,CAAC,KAAK,CAAC,eAAe,CAAC,CAAC;QAC/B,MAAM,EAAE,CAAC,EAAE,SAAS,EAAE,CAAC,EAAE,SAAS,EAAE,GAAG,IAAI,CAAC,WAAW,EAAE,CAAC;QAC1D,MAAM,EAAE,GAAG,EAAE,GAAG,WAAW,CAAC,GAAG,CAAC;QAEhC,MAAM,IAAI,IAAI,SAAS,GAAG,GAAG,CAAc,CAAC;QAC5C,MAAM,IAAI,IAAI,SAAS,GAAG,GAAG,CAAc,CAAC;QAC5C,IAAI,CAAC,aAAa,CACf,IAAI,EACJ,IAAI,CACN,CAAC;QACF,OAAO,CAAC,IAAI,CAAC,6BAA6B,IAAI,KAAK,IAAI,GAAG,CAAC,CAAC;QAC5D,IAAI,CAAC,YAAY,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;QAC9B,OAAO,CAAC,QAAQ,EAAE,CAAC;KACrB;IAIO,gBAAgB,CAAC,KAA0B;QAChD,OAAO,CAAC,KAAK,CAAC,kBAAkB,CAAC,CAAC;;QAElC,MAAM,aAAa,GAAG,KAAK,CAAC,WAAW,CAAC;QACxC,OAAO,CAAC,GAAG,CAAC,GAAG,aAAa,CAAC,KAAK,KAAK,aAAa,CAAC,MAAM,EAAE,CAAC,CAAC;QAC/DD,yBAAA,IAAI,mBAAmB,aAAa,CAAC,KAAkB,EAAC;QACxDA,yBAAA,IAAI,oBAAoB,aAAa,CAAC,MAAmB,EAAC;;QAG1D,MAAM,EAAE,CAAC,EAAE,SAAS,EAAE,CAAC,EAAE,SAAS,EAAE,GAAG,IAAI,CAAC,WAAW,EAAE,CAAC;QAC1D,MAAM,EAAE,GAAG,EAAE,GAAG,EAAE,GAAG,WAAW,CAAC,GAAG,CAAC;QAErC,IAAI,CAAC,aAAa,EACd,SAAS,GAAG,GAAG,IACf,SAAS,GAAG,GAAG,EACf,CAAC;QAEL,MAAM,IAAI,IAAI,SAAS,GAAG,GAAG,CAAgB,CAAC;QAC9C,MAAM,IAAI,IAAI,SAAS,GAAG,GAAG,CAAgB,CAAC;QAC9C,IAAI,CAAC,cAAc,CAChB,IAAI,EACJ,IAAI,CACN,CAAC;QAEF,OAAO,CAAC,IAAI,CAAC,8BAA8B,IAAI,KAAK,IAAI,GAAG,CAAC,CAAC;QAC7D,IAAI,CAAC,aAAa,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;QAC/B,OAAO,CAAC,QAAQ,EAAE,CAAC;KACrB;IAGO,iBAAiB;QACtB,WAAW,CAAC,YAAY,CAAC,IAAI,CAAC,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;QAC7DA,yBAAA,IAAI,6BACD,IAAI,oBAAoB,6CAAkB,IAAI,CAAC,gBAAgB,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,GAC5E;KACJ;IAwBD,IAAI,SAAS,KAAK,kDAAsB,EAAE;IAC1C,IAAI,MAAM,KAAK,+CAAmB,EAAE;IACpC,IAAI,GAAG,KAAK,4CAAgB,EAAE;IAC9B,IAAI,KAAK;QACN,OAAOC,wCAAa,KAAoB,CAAC;KAC3C;IACD,IAAI,MAAM;QACP,OAAOA,wCAAa,MAAqB,CAAC;KAC5C;;;AA3HD;;;;AAIO,eAAG,GAAG,MAAM,EAAE,CAAC;AACP,wBAAY,GAAmB,EAAE,CAAC;AAyHpD,mBAAmB,CAAC,WAAW,CAAC,SAAS,CAAC;;;;"}